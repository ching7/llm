# 训练错误分析：MPS 内存不足

## 错误现象

虽然代码检测到 Intel 芯片并显示使用 CPU，但训练时仍然出现 MPS 内存不足错误：

```
RuntimeError: MPS backend out of memory (MPS allocated: 5.38 GB, other allocations: 1.36 GB, max allowed: 6.77 GB). 
Tried to allocate 593.50 MB on private pool.
```

## 根本原因分析

### 1. **问题本质**

虽然代码设置了 `device = "cpu"`，但 **Trainer 或优化器仍然尝试使用 MPS**。这是因为：

1. **PyTorch 自动设备选择**：即使设置了 `device = "cpu"`，PyTorch 在某些情况下仍会尝试使用 MPS（如果可用）
2. **优化器状态创建**：错误发生在优化器的 `step()` 方法中，创建 `exp_avg_sq` 状态时
3. **MPS 未显式禁用**：虽然检测到 Intel 芯片，但没有显式禁用 MPS backend

### 2. **错误堆栈分析**

```
File "torch/optim/adamw.py", line 127, in _init_group
    state["exp_avg_sq"] = torch.zeros_like(...)
RuntimeError: MPS backend out of memory
```

- 错误发生在优化器初始化状态时
- `torch.zeros_like()` 创建的张量被放在了 MPS 设备上
- 说明优化器状态被创建在了错误的设备上

### 3. **为什么 Intel Mac 会尝试使用 MPS？**

虽然 Intel Mac 不支持 MPS，但：
- PyTorch 可能检测到系统有 Metal 支持（macOS 的图形 API）
- `torch.backends.mps.is_available()` 可能返回 `True`（即使实际上不可用）
- Trainer 自动选择"最佳"设备时可能选择了 MPS

## 解决方案

### 方案 1：显式禁用 MPS（已实施）

```python
# 在检测到 Intel Mac 时显式禁用 MPS
if is_intel_mac():
    if hasattr(torch.backends, "mps"):
        torch.backends.mps.enabled = False
```

### 方案 2：强制模型和参数在 CPU 上（已实施）

```python
# 确保模型在 CPU 上
if device == "cpu":
    model = model.cpu()
    # 确保所有参数都在 CPU 上
    for param in model.parameters():
        if param.device.type != "cpu":
            param.data = param.data.cpu()
```

### 方案 3：在 TrainingArguments 中明确指定（已实施）

```python
training_args = TrainingArguments(
    # ...
    no_cuda=(device == "cpu"),  # 明确禁用 CUDA/MPS
)
```

## 修复后的代码逻辑

1. **启动时检测芯片类型**
   - Intel Mac → 禁用 MPS
   - Apple Silicon → 启用 MPS（如果可用）

2. **设置设备**
   - Intel Mac → `device = "cpu"`
   - Apple Silicon → `device = "mps"`（如果可用）

3. **双重保险**
   - 在检测时禁用 MPS
   - 在设置设备时再次禁用 MPS
   - 在创建 Trainer 前强制模型在 CPU 上

4. **TrainingArguments 配置**
   - `no_cuda=True` 当使用 CPU 时
   - `fp16=False` 当使用 CPU 时

## 验证方法

修复后，运行训练脚本应该看到：

```
💻 检测到 Intel 芯片，使用 CPU 设备进行训练
ℹ️  Intel Mac 不支持 MPS (Metal) 加速，仅 Apple Silicon (M1/M2/M3) 支持
```

并且**不应该**再出现 MPS 相关的错误。

## 总结

**问题根源**：虽然检测到 Intel 芯片，但 MPS 未被显式禁用，导致优化器状态被创建在 MPS 设备上。

**解决方法**：
1. ✅ 显式禁用 MPS（Intel Mac）
2. ✅ 强制模型参数在 CPU 上
3. ✅ 在 TrainingArguments 中明确指定设备

现在代码应该可以正常在 Intel Mac 上使用 CPU 进行训练了。

